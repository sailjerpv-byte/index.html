<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regime-Aware Momentum Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141b3d;
            --bg-card: #1a2347;
            --text-primary: #e8edf4;
            --text-secondary: #8b95b5;
            --accent-green: #00ff88;
            --accent-red: #ff3366;
            --accent-yellow: #ffd93d;
            --accent-blue: #6c5ce7;
            --border: #2d3561;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 2rem 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease-out;
        }

        .header h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Regime Status */
        .regime-status {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            animation: slideDown 0.6s ease-out 0.2s both;
        }

        .regime-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .regime-mode {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .regime-mode.risk { color: var(--accent-green); }
        .regime-mode.defensive { color: var(--accent-red); }

        .voo-status {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .threshold-table {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .threshold-col {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid var(--accent-green);
        }

        .threshold-col.defensive {
            border-left-color: var(--accent-yellow);
        }

        .threshold-col h3 {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: var(--accent-green);
        }

        .threshold-col.defensive h3 {
            color: var(--accent-yellow);
        }

        .threshold-col ul {
            list-style: none;
            font-size: 0.85rem;
        }

        .threshold-col li {
            padding: 0.25rem 0;
            color: var(--text-secondary);
        }

        /* Controls */
        .controls {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            animation: slideDown 0.6s ease-out 0.4s both;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        input[type="text"], select {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        button {
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Countdown Timer */
        .countdown-timer {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            text-align: center;
            border: 2px solid var(--border);
        }

        .countdown-timer.active {
            display: block;
        }

        .countdown-timer.ready {
            border-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.1);
        }

        .countdown-timer.waiting {
            border-color: var(--accent-yellow);
            background: rgba(255, 217, 61, 0.1);
        }

        .timer-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 0.5rem;
        }

        .timer-display.waiting {
            color: var(--accent-yellow);
        }

        .timer-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Batch Processing */
        .batch-info {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--accent-blue);
        }

        .batch-info.active {
            display: block;
        }

        .batch-status {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .batch-progress {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .continue-button {
            margin-top: 1rem;
            background: linear-gradient(135deg, var(--accent-yellow), var(--accent-blue));
        }

        .pause-notice {
            display: none;
            margin-top: 1rem;
            padding: 1.5rem;
            background: rgba(255, 217, 61, 0.1);
            border: 2px solid var(--accent-yellow);
            border-radius: 8px;
            text-align: center;
        }

        .pause-notice.active {
            display: block;
        }

        .pause-notice h3 {
            color: var(--accent-yellow);
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .pause-notice p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Progress Bar */
        .progress-container {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: var(--bg-primary);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--bg-primary);
        }

        .progress-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            display: none;
        }

        .loading.active {
            display: block;
        }

        /* Ticker Cards */
        .ticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .ticker-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
            animation: fadeIn 0.6s ease-out;
        }

        .ticker-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px var(--shadow);
        }

        .ticker-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .ticker-symbol {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .ticker-meta {
            text-align: right;
            font-size: 0.8rem;
        }

        .asset-type {
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .active-mode {
            padding: 0.25rem 0.5rem;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .mode-a { color: var(--accent-green); }
        .mode-b { color: var(--accent-yellow); }

        .score-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .score-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .score-0, .score-1 { color: var(--accent-red); }
        .score-2 { color: var(--accent-yellow); }
        .score-3, .score-4 { color: var(--accent-green); }

        .score-info {
            flex: 1;
        }

        .signal {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .signal.deploy { color: var(--accent-green); }
        .signal.watch { color: var(--accent-yellow); }
        .signal.hold { color: var(--accent-red); }
        .signal.exit { color: var(--accent-red); }

        .breakdown {
            list-style: none;
            font-size: 0.85rem;
        }

        .breakdown li {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            background: var(--bg-secondary);
            border-radius: 4px;
            border-left: 3px solid var(--border);
        }

        .breakdown li.pass {
            border-left-color: var(--accent-green);
            color: var(--text-primary);
        }

        .breakdown li.fail {
            border-left-color: var(--accent-red);
            color: var(--text-secondary);
        }

        .breakdown li.pending {
            border-left-color: var(--accent-yellow);
            background: rgba(255, 217, 61, 0.1);
            color: var(--text-primary);
        }

        .volume-pending-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 217, 61, 0.2);
            border: 1px solid var(--accent-yellow);
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--accent-yellow);
            margin-left: 0.5rem;
        }

        /* Performance Warnings */
        .performance-metrics {
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--accent-blue);
        }

        .performance-metrics.warning {
            border-left-color: var(--accent-yellow);
            background: rgba(255, 217, 61, 0.1);
        }

        .performance-metrics.danger {
            border-left-color: var(--accent-red);
            background: rgba(255, 51, 102, 0.1);
        }

        .perf-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .perf-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .perf-stat {
            text-align: center;
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: 4px;
        }

        .perf-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            display: block;
        }

        .perf-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }

        .perf-value.positive { color: var(--accent-green); }
        .perf-value.negative { color: var(--accent-red); }

        .perf-warnings {
            margin-top: 0.75rem;
            font-size: 0.85rem;
        }

        .perf-warning-item {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            background: rgba(255, 217, 61, 0.15);
            border-left: 3px solid var(--accent-yellow);
            border-radius: 4px;
            color: var(--text-primary);
        }

        .perf-warning-item.danger {
            background: rgba(255, 51, 102, 0.15);
            border-left-color: var(--accent-red);
        }

        .position-suggestion {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(108, 92, 231, 0.15);
            border-left: 3px solid var(--accent-blue);
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .position-suggestion strong {
            color: var(--accent-blue);
        }

        /* Summary */
        .summary {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary h2 {
            margin-bottom: 1rem;
            color: var(--accent-blue);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .summary-section {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
        }

        .summary-section h3 {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-section ul {
            list-style: none;
            font-size: 0.85rem;
        }

        .summary-section li {
            padding: 0.25rem 0;
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .threshold-table {
                grid-template-columns: 1fr;
            }

            .ticker-grid {
                grid-template-columns: 1fr;
            }

            .regime-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem 0;
            color: var(--text-secondary);
            font-size: 0.85rem;
            border-top: 2px solid var(--border);
            margin-top: 3rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° REGIME-AWARE MOMENTUM DASHBOARD</h1>
            <p>Adaptive scoring based on market regime and asset classification</p>
        </div>

        <div class="regime-status" id="regimeStatus">
            <div class="regime-header">
                <div class="regime-mode risk" id="regimeMode">
                    <span id="regimeIcon">üìä</span>
                    <span id="regimeText">LOADING...</span>
                </div>
                <div class="voo-status" id="vooStatus">Checking VOO vs 200-DMA...</div>
            </div>

            <div class="threshold-table">
                <div class="threshold-col">
                    <h3>MODE A - STRICT (Risk Mode)</h3>
                    <ul>
                        <li>‚úì RSI ‚â• 55</li>
                        <li>‚úì Above BOTH 20-DMA & 50-DMA</li>
                        <li>‚úì Volume ‚â• 1.2√ó average</li>
                        <li>‚úì Positive vs SPY</li>
                    </ul>
                </div>
                <div class="threshold-col defensive">
                    <h3>MODE B - FLEXIBLE (Defensive Mode)</h3>
                    <ul>
                        <li>‚úì RSI ‚â• 45 & rising</li>
                        <li>‚úì Above 20-DMA or repairing</li>
                        <li>‚úì Volume ‚â• 1.0√ó average</li>
                        <li>‚úì Positive vs SPY</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="input-group">
                <label for="tickerInput">Enter Tickers (comma-separated):</label>
                <input type="text" id="tickerInput" placeholder="NVDA, MSFT, AVGO, VOO, VXUS" value="NVDA, MSFT, AVGO, GOOG, VOO, VXUS, TSM, AMD">
            </div>

            <div class="input-group">
                <label for="assetTypes">Asset Classification (Format: TICKER:TYPE)</label>
                <input type="text" id="assetTypes" placeholder="NVDA:RISK, VXUS:DEFENSIVE" 
                       value="NVDA:RISK, MSFT:RISK, AVGO:RISK, GOOG:RISK, VOO:RISK, VXUS:DEFENSIVE, VEA:DEFENSIVE, VGSH:DEFENSIVE, IAUM:DEFENSIVE, TSM:RISK, AMD:RISK, MU:RISK, LRCX:RISK, ASML:RISK, KLAC:RISK, BWXT:RISK, XOM:RISK, ITA:RISK, LHX:RISK, GD:RISK, VUG:RISK">
            </div>

            <button onclick="runAnalysis()">üöÄ ANALYZE MOMENTUM</button>

            <div class="countdown-timer" id="countdownTimer">
                <div class="timer-display" id="timerDisplay">Ready</div>
                <div class="timer-message" id="timerMessage">Click above to start analysis</div>
            </div>

            <div class="batch-info" id="batchInfo">
                <div class="batch-status" id="batchStatus">Processing in batches of 4 tickers...</div>
                <div class="batch-progress" id="batchProgress">Batch 1 of 3</div>
            </div>

            <div class="pause-notice" id="pauseNotice">
                <h3>‚è∏Ô∏è BATCH COMPLETE - WAITING FOR RATE LIMIT</h3>
                <p>Processed 4 tickers. Ready for next batch in <span id="pauseCountdown">60</span> seconds...</p>
                <button class="continue-button" id="continueButton" onclick="continueAnalysis()" disabled>
                    ‚è≥ Continue Next Batch (60s)
                </button>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="progress-text" id="progressText">Initializing...</div>
            </div>
        </div>

        <div id="results"></div>

        <div class="footer">
            <p>Built for Peter | Score 3+ = DEPLOY | Score 2 = WATCH | Score 0-1 = AVOID/EXIT</p>
            <p style="margin-top: 0.5rem;">Data provided by Twelve Data API</p>
        </div>
    </div>

    <script>
        // Twelve Data API Configuration
        const TWELVE_DATA_API_KEY = 'e58789837020410bb3a50420942ac926';
        
        // Batch processing state
        let batchState = {
            allTickers: [],
            currentBatch: 0,
            batchSize: 4,
            results: [],
            regimeMode: null,
            spyData: null,
            vooData: null,
            isProcessing: false
        };

        // Timer state
        let countdownInterval = null;
        let nextAvailableTime = Date.now();
        
        // Asset configuration
        let assetTypes = {};

        // Parse asset types from input
        function parseAssetTypes() {
            const input = document.getElementById('assetTypes').value;
            assetTypes = {};
            
            input.split(',').forEach(item => {
                const [ticker, type] = item.trim().split(':');
                if (ticker && type) {
                    assetTypes[ticker.toUpperCase()] = type.toUpperCase();
                }
            });
        }

        // Countdown timer
        function startCountdownTimer(seconds) {
            nextAvailableTime = Date.now() + (seconds * 1000);
            
            const timerEl = document.getElementById('countdownTimer');
            const displayEl = document.getElementById('timerDisplay');
            const messageEl = document.getElementById('timerMessage');
            
            timerEl.classList.add('active', 'waiting');
            timerEl.classList.remove('ready');
            
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                const remaining = Math.max(0, Math.ceil((nextAvailableTime - Date.now()) / 1000));
                
                if (remaining > 0) {
                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    displayEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    displayEl.classList.add('waiting');
                    messageEl.textContent = 'Waiting for rate limit cooldown...';
                } else {
                    displayEl.textContent = '‚úÖ Ready';
                    displayEl.classList.remove('waiting');
                    messageEl.textContent = 'Safe to run next analysis';
                    timerEl.classList.remove('waiting');
                    timerEl.classList.add('ready');
                    clearInterval(countdownInterval);
                }
            }, 100);
        }

        // Update progress bar
        function updateProgress(current, total, message) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const percentage = Math.round((current / total) * 100);
            
            progressContainer.classList.add('active');
            progressFill.style.width = percentage + '%';
            progressFill.textContent = percentage + '%';
            progressText.textContent = message;
        }

        // Show batch pause notice
        function showPauseNotice(batchNum, totalBatches, remainingTickers) {
            const pauseNotice = document.getElementById('pauseNotice');
            const pauseCountdown = document.getElementById('pauseCountdown');
            const continueButton = document.getElementById('continueButton');
            
            pauseNotice.classList.add('active');
            continueButton.disabled = true;
            
            let countdown = 60;
            pauseCountdown.textContent = countdown;
            continueButton.textContent = `‚è≥ Continue Next Batch (${countdown}s)`;
            
            const countdownTimer = setInterval(() => {
                countdown--;
                pauseCountdown.textContent = countdown;
                continueButton.textContent = `‚è≥ Continue Next Batch (${countdown}s)`;
                
                if (countdown <= 0) {
                    clearInterval(countdownTimer);
                    continueButton.disabled = false;
                    continueButton.textContent = `‚úÖ Continue with ${remainingTickers} tickers`;
                    pauseCountdown.textContent = '0';
                }
            }, 1000);
        }

        // Technical indicators
        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            
            const changes = [];
            for (let i = 1; i < prices.length; i++) {
                changes.push(prices[i] - prices[i - 1]);
            }
            
            const gains = changes.slice(-period).filter(x => x > 0);
            const losses = changes.slice(-period).filter(x => x < 0).map(Math.abs);
            
            const avgGain = gains.length ? gains.reduce((a, b) => a + b, 0) / period : 0;
            const avgLoss = losses.length ? losses.reduce((a, b) => a + b, 0) / period : 0;
            
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function calculateMA(prices, period) {
            if (prices.length < period) return prices[prices.length - 1];
            const slice = prices.slice(-period);
            return slice.reduce((a, b) => a + b, 0) / period;
        }

        function calculateVolRatio(volumes, period = 20) {
            if (volumes.length < period) return 1.0;
            
            // Check if market is open (rough estimate)
            const now = new Date();
            const hour = now.getHours();
            const day = now.getDay();
            
            // If it's a weekday (1-5) and between 9 AM - 4 PM, use YESTERDAY's volume
            // This avoids incomplete intraday volume from the API
            const isMarketHours = (day >= 1 && day <= 5) && (hour >= 9 && hour < 16);
            
            let currentVol;
            if (isMarketHours && volumes.length >= 2) {
                // Use previous day's volume (more reliable during market hours)
                currentVol = volumes[volumes.length - 2];
            } else {
                // Use today's volume (after hours or weekend)
                currentVol = volumes[volumes.length - 1];
            }
            
            const avgVol = calculateMA(volumes.slice(0, -1), period); // Average of historical, not including today
            
            // Handle missing or zero volume data
            if (!currentVol || currentVol === 0 || !avgVol || avgVol === 0) {
                return 1.0; // Return neutral if data is missing
            }
            
            // Simple calculation - just return the ratio
            return currentVol / avgVol;
        }

        // Calculate recent performance metrics
        function calculatePerformanceMetrics(prices) {
            const metrics = {
                change1Day: 0,
                change5Day: 0,
                change10Day: 0
            };

            if (prices.length < 2) return metrics;

            const currentPrice = prices[prices.length - 1];

            // 1-day change
            if (prices.length >= 2) {
                const price1DayAgo = prices[prices.length - 2];
                metrics.change1Day = ((currentPrice / price1DayAgo) - 1) * 100;
            }

            // 5-day change
            if (prices.length >= 6) {
                const price5DaysAgo = prices[prices.length - 6];
                metrics.change5Day = ((currentPrice / price5DaysAgo) - 1) * 100;
            }

            // 10-day change
            if (prices.length >= 11) {
                const price10DaysAgo = prices[prices.length - 11];
                metrics.change10Day = ((currentPrice / price10DaysAgo) - 1) * 100;
            }

            return metrics;
        }

        // Generate warnings based on performance
        function generatePerformanceWarnings(perf, rsi, score) {
            const warnings = [];
            let severity = 'normal'; // normal, warning, danger
            let positionSize = '1%'; // Suggested position size

            // Check for extended moves
            if (perf.change5Day > 10) {
                warnings.push({
                    text: `üî• Up ${perf.change5Day.toFixed(1)}% in 5 days - parabolic move, very high risk`,
                    level: 'danger'
                });
                severity = 'danger';
                positionSize = '0.25-0.5%';
            } else if (perf.change5Day > 7) {
                warnings.push({
                    text: `üìà Up ${perf.change5Day.toFixed(1)}% in 5 days - extended, consider smaller size`,
                    level: 'warning'
                });
                severity = 'warning';
                positionSize = '0.5-0.75%';
            } else if (perf.change5Day > 5) {
                warnings.push({
                    text: `üìä Up ${perf.change5Day.toFixed(1)}% in 5 days - some extension, watch for pullback`,
                    level: 'warning'
                });
                if (severity === 'normal') severity = 'warning';
                positionSize = '0.75%';
            }

            // Check for overbought + extended
            if (rsi > 75 && perf.change5Day > 5) {
                warnings.push({
                    text: `‚ö†Ô∏è Overbought (RSI ${rsi.toFixed(0)}) + extended move - high reversal risk`,
                    level: 'danger'
                });
                severity = 'danger';
                positionSize = '0.25-0.5%';
            } else if (rsi > 70 && perf.change5Day > 7) {
                warnings.push({
                    text: `‚ö†Ô∏è Elevated RSI + strong move - wait for pullback to 20-DMA`,
                    level: 'warning'
                });
                if (severity !== 'danger') severity = 'warning';
            }

            // Check for climax volume scenario
            // (would need volume data comparison - placeholder for now)

            // Fresh setup (good entry)
            if (perf.change5Day < 3 && perf.change5Day > -2 && score >= 3) {
                warnings.push({
                    text: `‚úÖ Fresh setup - minimal extension, good entry timing`,
                    level: 'normal'
                });
            }

            // Strong momentum continuation
            if (perf.change10Day > 15 && perf.change5Day > 5) {
                warnings.push({
                    text: `üöÄ Strong 10-day trend (+${perf.change10Day.toFixed(1)}%) - momentum established but late entry`,
                    level: 'warning'
                });
            }

            return { warnings, severity, positionSize };
        }

        // Fetch stock data from Twelve Data API
        async function fetchStockData(ticker) {
            const url = `https://api.twelvedata.com/time_series?symbol=${ticker}&interval=1day&outputsize=180&apikey=${TWELVE_DATA_API_KEY}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === 'error' || !data.values) {
                    throw new Error(data.message || 'Invalid data');
                }
                
                const values = data.values.reverse();
                const prices = values.map(v => parseFloat(v.close));
                const volumes = values.map(v => parseFloat(v.volume));
                
                return { prices, volumes };
            } catch (error) {
                console.error(`Error fetching ${ticker}:`, error);
                return null;
            }
        }

        // Determine regime mode
        function getRegimeMode(vooPrices) {
            if (vooPrices.length < 200) return 'RISK';
            
            const currentPrice = vooPrices[vooPrices.length - 1];
            const dma200 = calculateMA(vooPrices, 200);
            
            return currentPrice > dma200 ? 'RISK' : 'DEFENSIVE';
        }

        // Determine active mode for ticker
        function getActiveMode(ticker, regimeMode) {
            const assetType = assetTypes[ticker] || 'RISK';
            
            if (regimeMode === 'DEFENSIVE' || assetType === 'DEFENSIVE') {
                return 'MODE B';
            }
            return 'MODE A';
        }

        // Calculate regime-aware score
        function calculateScore(ticker, data, spyData, mode) {
            let score = 0;
            const breakdown = [];
            
            const prices = data.prices;
            const volumes = data.volumes;
            
            const currentPrice = prices[prices.length - 1];
            const prevPrice = prices[prices.length - 2] || currentPrice;
            const dma20 = calculateMA(prices, 20);
            const dma50 = calculateMA(prices, 50);
            const rsi = calculateRSI(prices);
            const prevRSI = calculateRSI(prices.slice(0, -1));
            const volRatio = calculateVolRatio(volumes); // Simple number
            
            // Calculate performance metrics
            const perf = calculatePerformanceMetrics(prices);
            
            let vsspy = 0;
            if (spyData && prices.length >= 20 && spyData.prices.length >= 20) {
                const tickerReturn = ((currentPrice / prices[prices.length - 20]) - 1) * 100;
                const spyReturn = ((spyData.prices[spyData.prices.length - 1] / spyData.prices[spyData.prices.length - 20]) - 1) * 100;
                vsspy = tickerReturn - spyReturn;
            }
            
            if (mode === 'MODE A') {
                if (rsi >= 55) {
                    score++;
                    breakdown.push({ text: `‚úÖ RSI ${rsi.toFixed(1)} (‚â•55)`, pass: true });
                } else {
                    breakdown.push({ text: `‚ùå RSI ${rsi.toFixed(1)} (need ‚â•55)`, pass: false });
                }
                
                if (currentPrice > dma20 && currentPrice > dma50) {
                    score++;
                    breakdown.push({ text: '‚úÖ Above both DMAs', pass: true });
                } else {
                    breakdown.push({ text: '‚ùå Below DMA(s)', pass: false });
                }
                
                // Volume check (simple)
                if (volRatio >= 1.2) {
                    score++;
                    breakdown.push({ text: `‚úÖ Vol ${volRatio.toFixed(2)}x (‚â•1.2x)`, pass: true });
                } else {
                    breakdown.push({ text: `‚ùå Vol ${volRatio.toFixed(2)}x (need ‚â•1.2x)`, pass: false });
                }
                
                if (vsspy > 0) {
                    score++;
                    breakdown.push({ text: `‚úÖ +${vsspy.toFixed(2)}% vs SPY`, pass: true });
                } else {
                    breakdown.push({ text: `‚ùå ${vsspy.toFixed(2)}% vs SPY`, pass: false });
                }
            } else {
                const rsiRising = rsi > prevRSI;
                
                if (rsi >= 45 && rsiRising) {
                    score++;
                    breakdown.push({ text: `‚úÖ RSI ${rsi.toFixed(1)} (‚â•45 & rising)`, pass: true });
                } else if (rsi >= 45) {
                    breakdown.push({ text: `‚ö†Ô∏è RSI ${rsi.toFixed(1)} (‚â•45 but not rising)`, pass: false });
                } else {
                    breakdown.push({ text: `‚ùå RSI ${rsi.toFixed(1)} (need ‚â•45 & rising)`, pass: false });
                }
                
                const repairing = currentPrice > dma20 && prevPrice < dma20;
                if (currentPrice > dma20) {
                    score++;
                    const tag = repairing ? ' (üîß REPAIR)' : '';
                    breakdown.push({ text: `‚úÖ Above 20-DMA${tag}`, pass: true });
                } else {
                    breakdown.push({ text: '‚ùå Below 20-DMA', pass: false });
                }
                
                // Volume check (MODE B uses lower threshold)
                if (volRatio >= 1.0) {
                    score++;
                    breakdown.push({ text: `‚úÖ Vol ${volRatio.toFixed(2)}x (‚â•1.0x)`, pass: true });
                } else {
                    breakdown.push({ text: `‚ùå Vol ${volRatio.toFixed(2)}x (need ‚â•1.0x)`, pass: false });
                }
                
                if (vsspy > 0) {
                    score++;
                    breakdown.push({ text: `‚úÖ +${vsspy.toFixed(2)}% vs SPY`, pass: true });
                } else {
                    breakdown.push({ text: `‚ùå ${vsspy.toFixed(2)}% vs SPY`, pass: false });
                }
            }
            
            // Generate performance warnings
            const perfAnalysis = generatePerformanceWarnings(perf, rsi, score);
            
            return { score, breakdown, perf, perfAnalysis };
        }

        function getSignal(score, perf) {
            if (score >= 3) {
                // TIMING GATE: Check 5-day performance
                if (perf.change5Day > 10) {
                    return { 
                        text: 'üî¥ TOO LATE', 
                        subtext: 'Parabolic move - very high risk',
                        class: 'exit',
                        size: '0.25% max'
                    };
                } else if (perf.change5Day > 5) {
                    return { 
                        text: 'üü° DEPLOY SMALL', 
                        subtext: 'Extended - reduced size or wait for pullback',
                        class: 'watch',
                        size: '0.5-0.75%'
                    };
                } else {
                    return { 
                        text: 'üü¢ DEPLOY NOW', 
                        subtext: 'Fresh setup - good timing',
                        class: 'deploy',
                        size: '1%'
                    };
                }
            }
            
            if (score === 2) {
                return { 
                    text: '‚ö†Ô∏è WATCH', 
                    subtext: 'Don\'t enter new - hold if owned',
                    class: 'watch',
                    size: '0%'
                };
            }
            
            if (score === 1) {
                return { 
                    text: 'üî¥ HOLD', 
                    subtext: 'Weakening - prepare to exit',
                    class: 'hold',
                    size: '0%'
                };
            }
            
            return { 
                text: 'üî¥ EXIT', 
                subtext: 'Trend broken - sell',
                class: 'exit',
                size: '0%'
            };
        }

        function renderResults(results, regimeMode) {
            const resultsDiv = document.getElementById('results');
            
            let cardsHTML = '<div class="ticker-grid">';
            
            results.forEach(result => {
                const signal = getSignal(result.score, result.perf);
                const modeClass = result.mode === 'MODE A' ? 'mode-a' : 'mode-b';
                const scoreClass = `score-${result.score}`;
                
                // Performance metrics display
                const perfClass = result.perfAnalysis.severity === 'danger' ? 'danger' : 
                                 result.perfAnalysis.severity === 'warning' ? 'warning' : '';
                
                const perfHTML = `
                    <div class="performance-metrics ${perfClass}">
                        <div class="perf-title">üìä Recent Performance</div>
                        <div class="perf-stats">
                            <div class="perf-stat">
                                <span class="perf-label">1-Day</span>
                                <span class="perf-value ${result.perf.change1Day >= 0 ? 'positive' : 'negative'}">
                                    ${result.perf.change1Day >= 0 ? '+' : ''}${result.perf.change1Day.toFixed(2)}%
                                </span>
                            </div>
                            <div class="perf-stat">
                                <span class="perf-label">5-Day</span>
                                <span class="perf-value ${result.perf.change5Day >= 0 ? 'positive' : 'negative'}">
                                    ${result.perf.change5Day >= 0 ? '+' : ''}${result.perf.change5Day.toFixed(2)}%
                                </span>
                            </div>
                            <div class="perf-stat">
                                <span class="perf-label">10-Day</span>
                                <span class="perf-value ${result.perf.change10Day >= 0 ? 'positive' : 'negative'}">
                                    ${result.perf.change10Day >= 0 ? '+' : ''}${result.perf.change10Day.toFixed(2)}%
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                
                cardsHTML += `
                    <div class="ticker-card">
                        <div class="ticker-header">
                            <div class="ticker-symbol">${result.ticker}</div>
                            <div class="ticker-meta">
                                <div class="asset-type">${result.assetType} Asset</div>
                                <div class="active-mode ${modeClass}">${result.mode}</div>
                            </div>
                        </div>
                        
                        <div class="score-display">
                            <div class="score-number ${scoreClass}">${result.score}<span style="font-size:1rem; color: var(--text-secondary);">/4</span></div>
                            <div class="score-info">
                                <div class="signal ${signal.class}">${signal.text}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">${signal.subtext}</div>
                                ${signal.size ? `<div style="font-size: 0.85rem; font-weight: 700; color: var(--accent-blue); margin-top: 0.5rem;">Position: ${signal.size}</div>` : ''}
                            </div>
                        </div>
                        
                        ${perfHTML}
                        
                        <ul class="breakdown">
                            ${result.breakdown.map(item => `
                                <li class="${item.pass ? 'pass' : 'fail'}">${item.text}</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            });
            
            cardsHTML += '</div>';
            
            const deploy = results.filter(r => r.score >= 3 && r.perf.change5Day <= 5);
            const deploySmall = results.filter(r => r.score >= 3 && r.perf.change5Day > 5 && r.perf.change5Day <= 10);
            const tooLate = results.filter(r => r.score >= 3 && r.perf.change5Day > 10);
            const watch = results.filter(r => r.score === 2);
            const avoid = results.filter(r => r.score <= 1);
            
            const summaryHTML = `
                <div class="summary">
                    <h2>üìã DEPLOYMENT RECOMMENDATIONS</h2>
                    <div class="summary-grid">
                        <div class="summary-section">
                            <h3><span>üü¢</span> DEPLOY NOW (${deploy.length})</h3>
                            <ul>
                                ${deploy.length ? deploy.map(r => `<li>‚Ä¢ ${r.ticker} - 1% position (${r.mode}) ${r.score}/4</li>`).join('') : '<li>None - Fresh Score 3-4 setups only</li>'}
                            </ul>
                        </div>
                        
                        <div class="summary-section">
                            <h3><span>üü°</span> DEPLOY SMALL (${deploySmall.length})</h3>
                            <ul>
                                ${deploySmall.length ? deploySmall.map(r => `<li>‚Ä¢ ${r.ticker} - 0.5-0.75% (extended +${r.perf.change5Day.toFixed(1)}%)</li>`).join('') : '<li>None</li>'}
                            </ul>
                        </div>
                        
                        <div class="summary-section">
                            <h3><span>üî¥</span> TOO LATE (${tooLate.length})</h3>
                            <ul>
                                ${tooLate.length ? tooLate.map(r => `<li>‚Ä¢ ${r.ticker} - Wait for pullback (parabolic +${r.perf.change5Day.toFixed(1)}%)</li>`).join('') : '<li>None</li>'}
                            </ul>
                        </div>
                        
                        <div class="summary-section">
                            <h3><span>‚ö†Ô∏è</span> WATCH (${watch.length})</h3>
                            <ul>
                                ${watch.length ? watch.map(r => `<li>‚Ä¢ ${r.ticker} - Hold if owned, don't enter new</li>`).join('') : '<li>None</li>'}
                            </ul>
                        </div>
                        
                        <div class="summary-section">
                            <h3><span>üî¥</span> AVOID/EXIT (${avoid.length})</h3>
                            <ul>
                                ${avoid.length ? avoid.map(r => `<li>‚Ä¢ ${r.ticker} (${r.mode}) - ${r.score}/4</li>`).join('') : '<li>None</li>'}
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-blue);">
                        <h3 style="color: var(--accent-blue); margin-bottom: 1rem; font-size: 1rem;">üìñ DEPLOYMENT RULES</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; font-size: 0.85rem;">
                            <div>
                                <div style="font-weight: 700; color: var(--accent-green); margin-bottom: 0.5rem;">üü¢ DEPLOY NOW (1%)</div>
                                <div style="color: var(--text-secondary);">Score 3-4 + 5-day change ‚â§5%<br>Fresh setup, good timing</div>
                            </div>
                            <div>
                                <div style="font-weight: 700; color: var(--accent-yellow); margin-bottom: 0.5rem;">üü° DEPLOY SMALL (0.5-0.75%)</div>
                                <div style="color: var(--text-secondary);">Score 3-4 + 5-day change 5-10%<br>Extended but manageable</div>
                            </div>
                            <div>
                                <div style="font-weight: 700; color: var(--accent-red); margin-bottom: 0.5rem;">üî¥ TOO LATE (0.25% max or WAIT)</div>
                                <div style="color: var(--text-secondary);">Score 3-4 + 5-day change >10%<br>Parabolic, high reversal risk</div>
                            </div>
                            <div>
                                <div style="font-weight: 700; color: var(--accent-yellow); margin-bottom: 0.5rem;">‚ö†Ô∏è WATCH (0%)</div>
                                <div style="color: var(--text-secondary);">Score 2 - Don't enter new<br>Hold if already owned</div>
                            </div>
                            <div>
                                <div style="font-weight: 700; color: var(--accent-red); margin-bottom: 0.5rem;">üî¥ EXIT (0%)</div>
                                <div style="color: var(--text-secondary);">Score 0-1 - Trend broken<br>Sell immediately</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = cardsHTML + summaryHTML;
        }

        // Process a single batch
        async function processBatch() {
            if (batchState.currentBatch === 0) {
                // First batch - fetch VOO and SPY
                updateProgress(0, 2, 'Fetching VOO for regime detection...');
                batchState.vooData = await fetchStockData('VOO');
                await new Promise(resolve => setTimeout(resolve, 8000));
                
                batchState.regimeMode = batchState.vooData ? getRegimeMode(batchState.vooData.prices) : 'RISK';
                
                // Update regime display
                const regimeModeEl = document.getElementById('regimeMode');
                const regimeTextEl = document.getElementById('regimeText');
                const regimeIconEl = document.getElementById('regimeIcon');
                const vooStatusEl = document.getElementById('vooStatus');
                
                regimeTextEl.textContent = `${batchState.regimeMode} MODE`;
                regimeModeEl.className = `regime-mode ${batchState.regimeMode.toLowerCase()}`;
                regimeIconEl.textContent = batchState.regimeMode === 'RISK' ? 'üìà' : 'üõ°Ô∏è';
                
                if (batchState.vooData) {
                    const currentPrice = batchState.vooData.prices[batchState.vooData.prices.length - 1];
                    const dma200 = calculateMA(batchState.vooData.prices, 200);
                    const pct = ((currentPrice / dma200 - 1) * 100).toFixed(2);
                    vooStatusEl.textContent = `VOO: $${currentPrice.toFixed(2)} vs 200-DMA: $${dma200.toFixed(2)} (${pct > 0 ? '+' : ''}${pct}%)`;
                }
                
                updateProgress(1, 2, 'Fetching SPY for relative strength...');
                batchState.spyData = await fetchStockData('SPY');
                await new Promise(resolve => setTimeout(resolve, 8000));
            }
            
            // Process current batch of tickers
            const startIdx = batchState.currentBatch * batchState.batchSize;
            const endIdx = Math.min(startIdx + batchState.batchSize, batchState.allTickers.length);
            const batchTickers = batchState.allTickers.slice(startIdx, endIdx);
            
            const totalBatches = Math.ceil(batchState.allTickers.length / batchState.batchSize);
            const batchInfo = document.getElementById('batchInfo');
            const batchProgress = document.getElementById('batchProgress');
            
            batchInfo.classList.add('active');
            batchProgress.textContent = `Batch ${batchState.currentBatch + 1} of ${totalBatches}`;
            
            for (let i = 0; i < batchTickers.length; i++) {
                const ticker = batchTickers[i];
                const overallIdx = startIdx + i;
                
                updateProgress(overallIdx + 1, batchState.allTickers.length, 
                    `Fetching ${ticker} (${overallIdx + 1}/${batchState.allTickers.length})...`);
                
                const data = await fetchStockData(ticker);
                
                if (data) {
                    const assetType = assetTypes[ticker] || 'RISK';
                    const mode = getActiveMode(ticker, batchState.regimeMode);
                    const { score, breakdown, perf, perfAnalysis } = calculateScore(ticker, data, batchState.spyData, mode);
                    
                    batchState.results.push({
                        ticker,
                        assetType,
                        mode,
                        score,
                        breakdown,
                        perf,
                        perfAnalysis
                    });
                    
                    // Render incrementally
                    renderResults(batchState.results, batchState.regimeMode);
                }
                
                if (i < batchTickers.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 8000));
                }
            }
            
            batchState.currentBatch++;
            
            // Check if more batches remain
            if (batchState.currentBatch < totalBatches) {
                const remainingTickers = batchState.allTickers.length - (batchState.currentBatch * batchState.batchSize);
                document.getElementById('progressContainer').classList.remove('active');
                showPauseNotice(batchState.currentBatch, totalBatches, remainingTickers);
            } else {
                // All done
                finishAnalysis();
            }
        }

        // Continue to next batch
        async function continueAnalysis() {
            document.getElementById('pauseNotice').classList.remove('active');
            document.getElementById('continueButton').disabled = true;
            await processBatch();
        }

        // Finish analysis
        function finishAnalysis() {
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('batchInfo').classList.remove('active');
            document.getElementById('pauseNotice').classList.remove('active');
            batchState.isProcessing = false;
            
            // Start cooldown timer (2 minutes)
            startCountdownTimer(120);
        }

        // Main analysis function
        async function runAnalysis() {
            // Check if still in cooldown
            if (Date.now() < nextAvailableTime) {
                alert('Please wait for the countdown timer to finish before running another analysis.');
                return;
            }
            
            // Parse inputs
            const tickersInput = document.getElementById('tickerInput').value;
            const tickers = tickersInput.split(',').map(t => t.trim().toUpperCase()).filter(t => t);
            
            if (tickers.length === 0) {
                alert('Please enter at least one ticker');
                return;
            }
            
            if (batchState.isProcessing) {
                alert('Analysis already in progress. Please wait or click Continue when ready.');
                return;
            }
            
            parseAssetTypes();
            
            // Reset state
            batchState = {
                allTickers: tickers,
                currentBatch: 0,
                batchSize: 4,
                results: [],
                regimeMode: null,
                spyData: null,
                vooData: null,
                isProcessing: true
            };
            
            document.getElementById('results').innerHTML = '';
            document.getElementById('pauseNotice').classList.remove('active');
            
            try {
                await processBatch();
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Error running analysis. Check console for details.');
                finishAnalysis();
            }
        }
    </script>
</body>
</html>
